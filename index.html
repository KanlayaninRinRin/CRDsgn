<div class="container">
<h1>Character Research Reference</h1>

<label>เลือกเซตติ้ง (บังคับ)</label>
<select id="setting-select">
  <option value="">-- เลือกเซตติ้ง --</option>
  <option value="modern">โลกมนุษย์ปัจจุบัน</option>
  <option value="fantasy">โลกแฟนตาซี</option>
  <option value="other">อื่น ๆ</option>
</select>
<input type="text" id="setting-custom" placeholder="กรอกเซตติ้งเอง" style="display:none;">

<label>เลือกหมวดข้อมูล (บังคับ)</label>
<select id="category">
  <option value="">-- เลือกประเภทข้อมูล --</option>
  <option value="inspiration">แรงบันดาลใจ</option>
  <option value="biology">ชีวภาพ</option>
  <option value="psychology">จิตวิทยา</option>
  <option value="society">สังคม</option>
</select>

<label>คำค้นเพิ่มเติม (ไม่บังคับ)</label>
<input type="text" id="search-input" placeholder="พิมพ์คำค้นเพิ่มเติม">

<button id="search-btn">ค้นหา</button>
<div class="feed" id="feed"></div>
<button id="next-btn" style="display:none;">หน้าถัดไป</button>
</div>

<script>
const settingSelect = document.getElementById("setting-select");
const settingCustom = document.getElementById("setting-custom");
const categorySelect = document.getElementById("category");
const searchInput = document.getElementById("search-input");
const searchBtn = document.getElementById("search-btn");
const feed = document.getElementById("feed");
const nextBtn = document.getElementById("next-btn");

let currentPage = 1;
let currentQuery = "";

// แสดง input กรอกเอง
settingSelect.addEventListener("change", ()=>{
  if(settingSelect.value==="other") settingCustom.style.display="block";
  else settingCustom.style.display="none";
});

async function loadFeed(reset=false){
  const category = categorySelect.value;
  const setting = (settingSelect.value==="other")? settingCustom.value.trim(): settingSelect.value;
  const query = searchInput.value.trim() || setting;

  if(!setting) return alert("กรุณาเลือกหรือกรอกเซตติ้ง");
  if(!category) return alert("กรุณาเลือกหมวด");

  if(reset){ feed.innerHTML=""; currentPage=1; nextBtn.style.display="none"; }

  feed.innerHTML="<p>กำลังโหลด...</p>";
  currentQuery = query;

  try{
    const res = await fetch(`https://fragrant-leaf-5042.jnnp1591.workers.dev/?category=${category}&q=${encodeURIComponent(query)}&page=${currentPage}`);
    const data = await res.json();

    feed.innerHTML="";
    if(!data || data.length===0){ feed.innerHTML="<p>ไม่พบผลลัพธ์</p>"; return; }

    // สุ่มผลลัพธ์ทุกครั้ง
    data.sort(()=>Math.random()-0.5);

    data.forEach(item=>{
      const card = document.createElement("div");
      card.className="card";

      if(item.type==="image"){
        card.innerHTML=`<img src="${item.image}" loading="lazy"><div class="content"><h4>${item.title}</h4></div>`;
      } else if(item.type==="research"){
        card.innerHTML=`<div class="content">
        <h4>${item.title}</h4>
        <p><strong>ผู้แต่ง:</strong> ${item.authors}</p>
        <p><strong>ปี:</strong> ${item.year}</p>
        <p><strong>สถาบัน:</strong> ${item.institution}</p>
        <a href="${item.link}" target="_blank">อ่านงานวิจัย</a>
        </div>`;
      }

      feed.appendChild(card);
    });

    nextBtn.style.display="block";

  }catch(err){
    console.error(err);
    feed.innerHTML="<p>เกิดข้อผิดพลาดในการโหลดข้อมูล</p>";
  }
}

searchBtn.addEventListener("click", ()=>loadFeed(true));
searchInput.addEventListener("keypress", e=>{ if(e.key==="Enter") loadFeed(true); });
nextBtn.addEventListener("click", ()=>{ currentPage++; loadFeed(false); });
</script>
