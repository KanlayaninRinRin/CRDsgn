<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Character Research Reference</title>

<style>
body {
  font-family: Arial, sans-serif;
  background:#fdf5ef;
  color:#3a2c2a;
  margin:0;
}
.container {
  max-width:1100px;
  margin:auto;
  padding:20px;
}
h1 {
  text-align:center;
  margin-bottom:20px;
}
select,input,button {
  width:100%;
  padding:10px;
  margin:8px 0;
  border-radius:8px;
  border:1px solid #ccc;
}
button {
  background:#8b5e3c;
  color:white;
  border:none;
  cursor:pointer;
}
button:hover { background:#70482d; }

.feed {
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:24px;
  margin-top:30px;
}

.card {
  background:#fff8f0;
  border-radius:14px;
  overflow:hidden;
  box-shadow:0 2px 8px rgba(0,0,0,0.15);
}

.card img {
  width:100%;
  height:180px;
  object-fit:cover;
  display:block;
}

.card .content {
  padding:12px;
}

.card h4 {
  margin:0 0 6px 0;
  font-size:14px;
}

.card p {
  font-size:12px;
  margin:4px 0;
}

.card a {
  color:#8b5e3c;
  font-size:13px;
  text-decoration:none;
}

.nav-buttons {
  display:flex;
  gap:12px;
  margin:30px 0;
  justify-content:center;
}
</style>
</head>

<body>
<div class="container">
<h1>Character Research Reference</h1>

<label>เลือกเซตติ้ง</label>
<select id="setting-select">
  <option value="">-- เลือกเซตติ้ง --</option>
  <option value="modern">โลกมนุษย์ปัจจุบัน</option>
  <option value="fantasy">โลกแฟนตาซี</option>
  <option value="other">อื่น ๆ</option>
</select>

<input id="setting-custom" placeholder="กรอกเซตติ้งเอง" style="display:none;">

<label>หมวดข้อมูล</label>
<select id="category">
  <option value="">-- เลือกหมวด --</option>
  <option value="inspiration">แรงบันดาลใจ</option>
  <option value="biology">ชีวภาพ</option>
  <option value="psychology">จิตวิทยา</option>
  <option value="society">สังคม</option>
</select>

<label>คำค้นเพิ่มเติม (ไม่บังคับ)</label>
<input id="search-input" placeholder="ถ้าไม่กรอก จะสุ่มจากเซตติ้ง">

<button id="search-btn">ค้นหา</button>

<div id="feed" class="feed"></div>

<div class="nav-buttons">
  <button id="prev-btn" style="display:none;">หน้าก่อนหน้า</button>
  <button id="next-btn" style="display:none;">หน้าถัดไป</button>
</div>
</div>

<script>
const settingSelect = document.getElementById("setting-select");
const settingCustom = document.getElementById("setting-custom");
const categorySelect = document.getElementById("category");
const searchInput = document.getElementById("search-input");
const searchBtn = document.getElementById("search-btn");
const feed = document.getElementById("feed");
const nextBtn = document.getElementById("next-btn");
const prevBtn = document.getElementById("prev-btn");

let currentPage = 1;

settingSelect.addEventListener("change",()=>{
  settingCustom.style.display =
    settingSelect.value === "other" ? "block" : "none";
});

async function loadFeed(reset=false){
  const category = categorySelect.value;
  const setting =
    settingSelect.value === "other"
    ? settingCustom.value.trim()
    : settingSelect.value;

  const query = searchInput.value.trim() || setting;

  if(!setting){ alert("กรุณาเลือกเซตติ้ง"); return; }
  if(!category){ alert("กรุณาเลือกหมวด"); return; }

  if(reset){
    currentPage = 1;
    feed.innerHTML = "";
  }

  feed.innerHTML = "<p>กำลังโหลดข้อมูล...</p>";

  try{
    const res = await fetch(
      `https://fragrant-leaf-5042.jnnp1591.workers.dev/?category=${category}&q=${encodeURIComponent(query)}&page=${currentPage}`
    );
    const data = await res.json();

    feed.innerHTML = "";

    let imageCount = 0;
    let researchCount = 0;

    data.forEach(item=>{
      if(imageCount>=20 && researchCount>=20) return;

      const card = document.createElement("div");
      card.className="card";

      if(item.type==="image" && imageCount<20){
        const imgUrl =
          `https://source.unsplash.com/400x300/?${encodeURIComponent(item.query)}&sig=${item.sig}`;

        card.innerHTML =
          `<img src="${imgUrl}">
           <div class="content"><h4>${item.title}</h4></div>`;
        imageCount++;

      } else if(item.type==="research" && researchCount<20){
        card.innerHTML =
          `<div class="content">
            <h4>${item.title}</h4>
            <p>ผู้แต่ง: ${item.authors}</p>
            <p>ปี: ${item.year}</p>
            <p>สถาบัน: ${item.institution}</p>
            <a href="${item.link}" target="_blank">อ่านงานวิจัย</a>
          </div>`;
        researchCount++;
      }
      feed.appendChild(card);
    });

    nextBtn.style.display="block";
    prevBtn.style.display = currentPage>1 ? "block":"none";

  }catch(err){
    console.error(err);
    feed.innerHTML="<p>เกิดข้อผิดพลาดในการโหลดข้อมูล</p>";
  }
}

searchBtn.addEventListener("click",()=>loadFeed(true));
nextBtn.addEventListener("click",()=>{
  currentPage++;
  loadFeed(false);
});
prevBtn.addEventListener("click",()=>{
  if(currentPage>1){
    currentPage--;
    loadFeed(false);
  }
});
</script>
</body>
</html>
