<div class="container">
  <h3>เลือกหมวดข้อมูล</h3>
  <select id="category">
    <option value="">-- เลือกประเภทข้อมูล --</option>
    <option value="modern">โลกมนุษย์ปัจจุบัน</option>
    <option value="fantasy">โลกแฟนตาซี</option>
    <option value="other">อื่น ๆ</option>
  </select>

  <input type="text" id="custom-setting" placeholder="ระบุเซตติ้งเอง (ไม่บังคับ)">
  <input type="text" id="search-input" placeholder="พิมพ์คำค้นหา (ไม่บังคับ)">
  <button id="search-btn">ค้นหา</button>

  <div class="feed" id="feed"></div>
  <button id="next-btn" style="margin-top:20px;">หน้าถัดไป</button>
</div>

<script>
const categorySelect = document.getElementById("category");
const customSetting = document.getElementById("custom-setting");
const searchInput = document.getElementById("search-input");
const searchBtn = document.getElementById("search-btn");
const feed = document.getElementById("feed");
const nextBtn = document.getElementById("next-btn");

let currentPage = 1;
let loading = false;
let lastQuery = "";

// โหลด feed
async function loadFeed(reset=false){
  const category = categorySelect.value;
  if(!category) return alert("กรุณาเลือกเซตติ้ง");

  let query = searchInput.value.trim();
  if(!query){
    if(category === "other"){
      query = customSetting.value.trim() || "random";
    } else {
      query = category;
    }
  }

  lastQuery = query;

  if(reset){ feed.innerHTML=""; currentPage=1; }

  feed.innerHTML="<p>กำลังโหลด...</p>";
  if(loading) return;
  loading = true;

  try{
    const res = await fetch(`https://fragrant-leaf-5042.jnnp1591.workers.dev/?category=${category}&q=${encodeURIComponent(query)}&page=${currentPage}`);
    const data = await res.json();
    feed.innerHTML="";

    if(!data || data.length===0){ feed.innerHTML="<p>ไม่พบผลลัพธ์</p>"; loading=false; return; }

    // แยกภาพและวิจัย
    const images = data.filter(d=>d.type==="image").slice(0,20);
    const research = data.filter(d=>d.type==="research").slice(0,20);

    const columns = [[],[],[],[]]; // 0-1: images, 2-3: research
    images.forEach((img,i)=> columns[i%2].push(img));
    research.forEach((res,i)=> columns[2 + (i%2)].push(res));

    feed.innerHTML = "<div style='display:grid;grid-template-columns:1fr 1fr 1fr 1fr; gap:16px;'></div>";
    const grid = feed.firstChild;

    for(const col of columns){
      const colDiv = document.createElement("div");
      col.forEach(item=>{
        const card = document.createElement("div");
        card.className="card";

        if(item.type==="image"){
          card.innerHTML=`<img src="${item.image}" loading="lazy"><div class="content"><h4>${item.title}</h4></div>`;
        } else if(item.type==="research"){
          card.innerHTML=`<div class="content"><h4>${item.title}</h4>
            <p><strong>ผู้แต่ง:</strong> ${item.authors}</p>
            <p><strong>ปี:</strong> ${item.year}</p>
            <p><strong>สถาบัน:</strong> ${item.institution}</p>
            <a href="${item.link}" target="_blank">อ่านงานวิจัย</a>
          </div>`;
        }
        colDiv.appendChild(card);
      });
      grid.appendChild(colDiv);
    }

  }catch(err){
    console.error(err);
    feed.innerHTML="<p>เกิดข้อผิดพลาดในการโหลดข้อมูล</p>";
  }

  loading=false;
}

// ปุ่มค้นหา
searchBtn.addEventListener("click", ()=>loadFeed(true));
searchInput.addEventListener("keypress", e=>{if(e.key==="Enter") loadFeed(true);});

// หน้าถัดไป
nextBtn.addEventListener("click", ()=>{
  currentPage++;
  loadFeed(false);
});
</script>
